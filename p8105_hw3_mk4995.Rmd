---
title: "Homework 3"
author: "Maya Krishnamoorthy"
date: "2024-10-06"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
```

## Problem 1

```{r}
library(p8105.datasets)
data("ny_noaa")
```

This dataset contains `r nrow(ny_noaa)` rows and `r ncol(ny_noaa)` columns. Variables include weather station id, date of observation,  (tenths of mm), snowfall (mm), snow depth (mm), and min and max temperature (tenths of degrees C).

Below we clean the data, creating separate variables for year, month, and day and converting `tmax` and `tmin` to numeric. We find that 0 is the most commonly observed value for snowfall. This is because most days of the year, it does not snow at all in NY. The second most commonly observed value is `NA`, indicating missingness. Other common values are 13, 25, and 51, suggesting that snowfall is originally recorded in fractions of an inch and converted to mm.

```{r}
ny_noaa %>% 
  count(snow) %>%
  arrange(desc(n))

ny_noaa = 
  ny_noaa %>% 
  separate(date, into = c("year", "month", "day"), convert = TRUE) %>% 
  mutate(
    tmax = as.numeric(tmax),
    tmin = as.numeric(tmin))
```

Below is a two-panel plot showing the average max temperature in January and in July in each station across years. As expected, the mean temperature in January is much lower than the mean temperature in July for all stations and across all years. All stations appear to follow similar trends of temperature peaks and valleys within a month across the years, i.e. when one station has a high monthly mean temperature for a given year, most other stations also have a high monthly mean temperature for that year. We do see one uncharacteristically cold station in July of 1987 or 1988, as well as a few other less drastic outliers.

```{r}
ny_noaa %>% 
  group_by(id, year, month) %>% 
  filter(month %in% c(1, 7)) %>% 
  summarize(mean_tmax = mean(tmax, na.rm = TRUE, color = id)) %>% 
  ggplot(aes(x = year, y = mean_tmax, group = id)) + geom_point() + geom_path() +
  facet_grid(~month) +
  labs(title = "Mean monthly temperature for each station across years for January and July")
```

Below we show a two-panel plot including (i) a hex plot of `tmax` vs `tmin` for the full dataset; and (ii) a ridge plot showing the distribution of snowfall values (in mm) greater than 0 and less than 100 separately by year. 

From the hex plot we see that while there is some variability, the majority of the data cluster tightly in the center of the distribution. In relatively rare cases, it seems that `tmax` is less than `tmin`, which raises questions about data recording and quality.

```{r}
hex = 
  ny_noaa %>% 
  ggplot(aes(x = tmin, y = tmax)) + 
  geom_hex()

hex
```

## Problem 2

*Start by organizing the datasets - load, clean, merge, and organize into a final `merged_df` dataset.*

```{r organize, message = FALSE}
# Import and clean nhanes_accel.csv
accel_df = 
  read_csv("data/nhanes_accel.csv") |> 
  janitor::clean_names() |> 
  pivot_longer(
    min1:min1440,
    names_to = "minute_interval",
    names_prefix = "min",
    values_to = "mims"
  ) |> # Pivot these columns 
  mutate(
    minute_interval = as.numeric(minute_interval)
  )

covar_df = 
  read_csv("data/nhanes_covar.csv", skip = 4) |> # skip first 4 rows
  janitor::clean_names() |> 
  drop_na(sex, age, bmi, education) |> # drop N/A rows from demographic data
  filter(!(age < 21)) |> # filter out people younger than 21
  mutate( # encode variable with reasonable names
    sex = case_match(
      sex,
      1 ~ "Male",
      2 ~ "Female"
    ),
    education = case_match(
      education, 
      1 ~ "Less than high school",
      2 ~ "High school equivalent",
      3 ~ "More than high school"
    ),
    education = factor( # create factor variable
      education,
      levels = c("Less than high school", "High school equivalent", "More than high school")
    )
  )

merged_df = left_join( # merge datasets using a left join so it only includes the data specified from the covar_df
  covar_df, 
  accel_df, 
  by = "seqn"
)
```


*Produce a reader-friendly table for the number of men and women in each education category.*

```{r education_categories, messsage=FALSE}

# Create reader-friendly table for the number of men and women in each educ category
merged_df |> 
  distinct(seqn, .keep_all = TRUE) |> # keep all columns but identify unique seq numbers
  group_by(education, sex) |> # group by education and sex 
  summarize(count = n()) |> # get male/female counts
  pivot_wider( # make more reader friendly (male/female)
    names_from = sex,
    values_from = count
  ) |> 
  knitr::kable()
```

Thee are about the same number of female and male participants in each education category except there are far more males in the high school equivalent group.

*Create a visualization of the age distributions for men and women in each education category.*

```{r}
merged_df |> 
  distinct(seqn, .keep_all = TRUE) |> # keep all columns but identify unique seq numbers
  ggplot(aes(x = age, fill = sex)) +
  geom_histogram(position = "dodge", bins = 10) +
  facet_grid(. ~ education) + 
  theme(legend.position = "bottom") +
  labs(
    title = "Age Distribution by Sex and Education Level",
    fill = "Sex"
  ) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10))
```

There is a concentration of female participants in their 40s and 50s belonging to the more than high school category, while fewer women in the same age group have lower education levels. For males, there is a more even distribution across all ages, but there is a higher concentration of individuals in their 30s and 40s with more than a high school education. Overall, both men and women with higher education levels are distributed more evenly across various age groups, while those with less education are less represented, particularly at younger ages.


*Using your tidied dataset, aggregate across minutes to create a total activity variable for each participant.*

```{r message=FALSE}
merged_df |> 
  group_by(seqn, sex, age, education) |> 
  summarize(
    total_mims = sum(mims, na.rm = TRUE)
  ) |> 
  distinct(seqn, .keep_all = TRUE) |> 
  ggplot(aes(x = age, y = total_mims, color = sex)) +
  geom_point() +
  geom_smooth(method = "loess") +
  facet_grid(. ~ education) +
  theme(legend.position = "bottom") +
  labs(
    title = "Total Activity over the Day",
    color = "Sex",
    x = "Age",
    y = "Total Activity (mins)"
  )
```

Females tend to have a higher total activity level than males in all panels. Overall, in all education categories, there is a general decline in total activity as age increases, especially noticeable after the age of 60. This trend is consistent for both males and females, with some fluctuations before age 60 depending on the education level. Individuals with higher education tend to show a more gradual decline in activity compared to those with less education.

```{r message=FALSE}
merged_df |> 
  ggplot(aes(x = minute_interval, y = mims, group = seqn, color = sex)) +
  geom_line(alpha = 0.1) + 
  geom_smooth(aes(group = sex), se = FALSE) +
  facet_grid(. ~ education) +
  labs(
    title = "24-hour activity time courses by education and sex",
    x = "Minutes",
    Y = "Activity",
    color = "Sex"
  ) +
  scale_x_continuous(
    breaks = c(0, 500, 1000),
    limits = c(0, 1440),
    labels = c("0", "500", "1000")
  )
```

This graph depicts 24-hour activity time courses by education level and sex. It is divided into three panels representing different education levels: Less than high school, High school equivalent, and More than high school. The y-axis shows activity levels in terms of "mims" (a measurement of physical activity intensity), while the x-axis spans a 24-hour period in minutes (0-1440 minutes). 

There is a low activity period early in the day, which is likely when individuals are asleep, followed by an increase later in the morning and through the day as expected. Males with more than high school education tend to participate in less intense physical activity throughout the day compared to females with more than high school levels of education.

## Problem 3

*Import, clean, and tidy these data, and describe the resulting dataset.*

```{r message=FALSE}

# Import each dataset, remove duplicates, and add date columns (month and year).

jan_2020 =
  read_csv("data/citibike/Jan 2020 Citi.csv") |> 
  janitor::clean_names() |> 
  mutate(
    month = "January",
    year = 2020
  ) |> 
  distinct(ride_id, .keep_all = TRUE)

jan_2024 =
  read_csv("data/citibike/Jan 2024 Citi.csv") |> 
  janitor::clean_names() |> 
  mutate(
    month = "January",
    year = 2024
  ) |> 
  distinct(ride_id, .keep_all = TRUE)

jul_2020 =
  read_csv("data/citibike/July 2020 Citi.csv") |> 
  janitor::clean_names() |> 
  mutate(
    month = "July",
    year = 2020
  ) |> 
  distinct(ride_id, .keep_all = TRUE)

jul_2024 =
  read_csv("data/citibike/July 2024 Citi.csv") |> 
  janitor::clean_names() |> 
  mutate(
    month = "July",
    year = 2024
  ) |> 
  distinct(ride_id, .keep_all = TRUE)

# Bind the rows together.

citibike_tidy_df = 
  bind_rows(jan_2020, jan_2024, jul_2020, jul_2024) |> 
  mutate(
    rideable_type = case_match( # remove suffix "_bike"
      rideable_type,
      "classic_bike" ~ "classic",
      "electric_bike" ~ "electric"
    ),
    rideable_type = factor( # turn ride type into a factor variable
      rideable_type,
      levels = c("classic", "electric")
    ),
    member_casual = factor( # turn member_casual into a factor variable
      member_casual,
      levels = c("member", "casual")
    ),
    weekdays = factor(
      weekdays,
      levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")
    )
  ) |> 
  arrange(year, month) # sort by date

# Check if there are any NA values in the ride_id column
any(is.na(citibike_tidy_df$ride_id))

# Get number of rows and columns in dataframe.
nrows = nrow(citibike_tidy_df)
ncols = ncol(citibike_tidy_df)
```

Each dataset was first cleaned separately by using the janitor package, removing duplicate ride_ids, and adding month/year columns. Then, the four datasets (from January and July of 2020 and 2024) were merged using bind_rows(). I then converted `rideable_type` and `member_casual` into factor variables, and removed the suffix "_bike" from the `rideable_type` values. The resulting dataset has `r nrows` rows and `r ncols` columns. The columns are as follows:
* `ride_id`
* `rideable_type`: Electric or Classic
* `weekdays`
* `start_station_name`
* `end_station_name`
* `member_casual`: Member or Casual
* `month`
* `year`


*Produce a reader-friendly table showing the total number of rides in each combination of year and month separating casual riders and Citi Bike members.*

```{r message=FALSE}
citibike_tidy_df |> 
group_by(member_casual, year, month) |> # group by member_casual and month/year
  summarize(count = n()) |> # get counts organized by groups (month, year, member_casual)
  pivot_wider( # make more reader friendly (member/casual)
    names_from = member_casual,
    values_from = count
  ) |> 
  knitr::kable()
```

As seen in the table, there are generally more members than casual riders. There is a substantial increase in riders for both caetgories in the summer months compared to winter. The increase is most notable for members in 2024 between January and July. We can also note the decrease for casual members between July 2020 and January 2024, whereas there was a slight increase in members, which may indicate that Citibke has a good retention of members, but not for casual riders.

*Make a table showing the 5 most popular starting stations for July 2024; include the number of rides originating from these stations.*
```{r}
citibike_tidy_df |> 
  group_by(start_station_name) |> # group by starting station
  filter(
    month == "July",
    year == 2024
  ) |> 
  summarize(count = n()) |> # count by start station
  arrange(desc(count)) |> # organize by most popular
  head(5) |> # print the first 5
  knitr::kable()
```

*Make a plot to investigate the effects of day of the week, month, and year on median ride duration.*

```{r message=FALSE}
citibike_tidy_df |> 
  group_by(year, month, weekdays) |> 
  summarize(median_duration = median(duration, na.rm = TRUE)) |> 
  ggplot(aes(x = weekdays, y = median_duration, fill = month)) +
  geom_bar(stat = "identity", position = "dodge") + 
  facet_grid(month ~ year) +
  labs(
    x = "Weekdays",
    y = "Median Ride Duration (mins)",
    fill = "Month",
    title = "Median Ride Duration by Weekday, Month, and Year"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom"
  )
```

The graph above describes the distriibution of median ride duration per weekday in January and July 2020 and 2024. July generally shows higher median ride durations across all weekdays compared to January for both years (2020 and 2024), which reflects the warmer weather that is more suitable for biking. Saturday and Sunday (weekends) exhibit longer median ride durations compared to weekdays, especially in July for both 2020 and 2024. The pattern of shorter rides during weekdays and longer rides on weekends is consistent across 2020 and 2024, indicating a stable pattern of usage. The median durations in July 2024 appear to be slightly shorter than in July 2020 for weekdays.

*For data in 2024, make a figure that shows the impact of month, membership status, and bike type on the distribution of ride duration.*

```{r message=FALSE}
citibike_tidy_df |> 
  filter(year == 2024) |> 
  ggplot(aes(x = duration, fill = month)) +
  geom_histogram(position = "dodge", bins = 10) + 
  facet_wrap(~ member_casual + rideable_type, ncol = 2) +
  labs(
    title = "Ride Duration Distribution by Month, Membership, and Bike Type (2024)",
    x = "Ride Duration (mins)",
    y = "Count of Rides",
    fill = "Month"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom"
  ) +
  xlim(0, 150)
```

Based on the histogram distribution of ride duration above, we can examine the effects of month, membership status (casual or member), and ride type (classic or electric bike). Overall, members are more likely to exhibit more consistent, shorter rides. There are more electric bikes in earlier duration, possibly because they are faster. Longer rides may occur in summer months like July due to better weather and recreational use. Shorter rides may be more common in January, likely for practical purposes like commuting.



